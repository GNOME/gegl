stages:
  - dependencies
  - gegl

variables:
  BABL_DIR: "_babl_install"
  BABL_PREFIX: "$CI_PROJECT_DIR/$BABL_DIR"
  CCACHE_BASEDIR: "${PWD}"
  CCACHE_DIR: "${PWD}/ccache"

cache:
  paths:
  - _pacman_cache
  - ccache

image: archlinux/base:latest

.babl-base:
  stage: dependencies
  artifacts:
    paths:
    - $BABL_DIR
  variables:
    GIT_DEPTH: "5"
  before_script:
    - pacman -Syu --noconfirm --needed --cachedir "${PWD}/_pacman_cache"
      git base-devel ccache meson lcms2 gobject-introspection
    - git clone --depth=$GIT_DEPTH https://gitlab.gnome.org/GNOME/babl.git _babl
    - cd _babl

babl-git:
  extends: .babl-base
  variables:
    GIT_STRATEGY: none
  script:
    - meson -Dprefix="$BABL_PREFIX" _build
    - ninja -C _build
    - ninja -C _build install

babl-min:
  extends: .babl-base
  script:
    - grep "'babl'" ../meson.build | grep -o '[0-9\.]*' | sed 's|\.|_|g' > .babl_min_version
    - git fetch --no-tags origin "refs/tags/BABL_`cat .babl_min_version`:refs/tags/MIN_VERSION"
    - git checkout MIN_VERSION
    - meson -Dprefix="$BABL_PREFIX" _build
    - ninja -C _build
    - ninja -C _build install

.build-gegl:
  stage: gegl
  variables:
    GIT_DEPTH: "15"
  before_script:
    - pacman -Syu --noconfirm --needed --cachedir "${PWD}/_pacman_cache"
        base-devel ccache meson
        gobject-introspection
        ffmpeg
        gobject-introspection
        graphviz
        jasper
        json-glib
        lcms2
        libgexiv2
        libraw
        librsvg
        libspiro
        libtiff
        luajit
        openexr
        python
        sdl2
        suitesparse
  script:
    - PKG_CONFIG_PATH=$BABL_PREFIX/lib/pkgconfig
      meson -Dprefix="$BABL_PREFIX" _build
    - LD_LIBRARY_PATH="$BABL_PREFIX/lib:$LD_LIBRARY_PATH"
      ninja -C _build
    - LD_LIBRARY_PATH="$BABL_PREFIX/lib:$LD_LIBRARY_PATH"
      ninja -C _build install

.build-default:
  extends: .build-gegl
  variables:
    CONFIG_OPTIONS: ""

.build-all:
  extends: .build-gegl
  variables:
    CONFIG_OPTIONS: "-Denable-mmx=true -Denable-sse=true --auto-features=enabled"

build-default-git:
  extends: .build-default
  dependencies:
    - babl-git

build-default-min:
  extends: .build-default
  dependencies:
    - babl-min

build-all-git:
  extends: .build-all
  dependencies:
    - babl-git

build-all-min:
  extends: .build-all
  dependencies:
    - babl-min
